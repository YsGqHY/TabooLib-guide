name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - uses: pnpm/action-setup@v4
        
    - name: Get pnpm store
      run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: ${{ runner.os }}-pnpm-store-

    - run: pnpm install --frozen-lockfile
      
    - run: pnpm build
      env:
        NODE_OPTIONS: --max-old-space-size=4096

    # 测试 SSH 连接
    - name: Test SSH Connection
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "✅ SSH 连接成功！"
          echo "服务器主机名: $(hostname)"
          echo "当前用户: $(whoami)"
          echo "服务器时间: $(date)"
          echo "目标目录检查:"
          ls -la ${{ secrets.TARGET_DIR }} || echo "目标目录不存在，将在部署时创建"

    # 上传构建文件到服务器
    - name: Upload build files to server
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: ${{ secrets.SSH_PORT }}
        source: "build/*"
        target: ${{ secrets.TARGET_DIR }}
        strip_components: 1
        rm: true

    # 验证部署结果
    - name: Verify deployment
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "验证部署结果..."
          ls -lah ${{ secrets.TARGET_DIR }}
          echo "✅ 部署完成！"